<!doctype html><html lang=en dir=ltr><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>Workflow Automation Guide | BigLedger - Complete Business Management Platform</title><meta name=description content="Design and implement automated business processes with BigLedger's workflow engine, webhooks, and batch operations."><link rel=icon type=image/png href=https://www.bigledger.com/images/bigledger-logo-cropped.png><link rel=preconnect href=https://fonts.googleapis.com><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel=stylesheet><link rel=stylesheet href=https://www.bigledger.com/css/custom.css><meta property="og:title" content="Workflow Automation Guide"><meta property="og:description" content="Design and implement automated business processes with BigLedger's workflow engine, webhooks, and batch operations."><meta property="og:type" content="website"><meta property="og:url" content="https://www.bigledger.com/developers/automation-workflows/"></head><body><header class=corporate-header><div class=container><nav class=nav><div class=nav-logo><a href=https://www.bigledger.com/><img src=https://www.bigledger.com/images/bigledger-logo-cropped.png alt="BigLedger - Complete Business Management Platform" height=40></a></div><div class=nav-menu><a href=https://www.bigledger.com/ class=nav-link>Home</a>
<a href=https://www.bigledger.com/about/ class=nav-link>About</a>
<a href=https://www.bigledger.com/solutions/ class=nav-link>Solutions</a>
<a href=https://www.bigledger.com/pricing/ class=nav-link>Pricing</a>
<a href=https://www.bigledger.com/contact/ class=nav-link>Contact</a>
<a href=https://www.bigledger.com/developers/ class=nav-link>Developers</a></div><div class=nav-cta><a href=https://www.bigledger.com/contact class=btn-primary>Get Started</a></div></nav></div></header><main><article class=corporate-page><div class=container><div class=page-content><p>Design and implement sophisticated automated business processes using BigLedger&rsquo;s comprehensive automation tools. Perfect for DevOps engineers, process automation experts, and workflow designers.</p><div class="hx:overflow-x-auto hx:mt-6 hx:flex hx:rounded-lg hx:border hx:py-2 hx:ltr:pr-4 hx:rtl:pl-4 hx:contrast-more:border-current hx:contrast-more:dark:border-current hx:border-blue-200 hx:bg-blue-100 hx:text-blue-900 hx:dark:border-blue-200/30 hx:dark:bg-blue-900/30 hx:dark:text-blue-200"><div class="hx:ltr:pl-3 hx:ltr:pr-2 hx:rtl:pr-3 hx:rtl:pl-2"><div class="hx:select-none hx:text-xl" style="font-family:apple color emoji,segoe ui emoji,segoe ui symbol">ℹ️</div></div><div class="hx:w-full hx:min-w-0 hx:leading-7"><div class="hx:mt-6 hx:leading-7 hx:first:mt-0"><strong>Event-Driven Automation</strong>: BigLedger&rsquo;s automation framework is built around events, webhooks, and intelligent workflow orchestration that can handle complex business logic and approval processes.</div></div></div><h2>Automation Overview<span class="hx:absolute hx:-mt-20" id=automation-overview></span>
<a href=#automation-overview class=subheading-anchor aria-label="Permalink for this section"></a></h2><p>BigLedger provides multiple automation mechanisms:</p><ul><li><strong>Webhook-Triggered Workflows</strong>: React to business events in real-time</li><li><strong>Scheduled Operations</strong>: Time-based automation for reports, backups, and maintenance</li><li><strong>Business Rule Engine</strong>: Automated decision making and approval workflows</li><li><strong>Batch Processing</strong>: Handle large-scale data operations efficiently</li><li><strong>Integration Automation</strong>: Sync data between BigLedger and external systems</li></ul><h2>Event-Driven Workflows<span class="hx:absolute hx:-mt-20" id=event-driven-workflows></span>
<a href=#event-driven-workflows class=subheading-anchor aria-label="Permalink for this section"></a></h2><h3>Setting Up Webhook-Based Automation<span class="hx:absolute hx:-mt-20" id=setting-up-webhook-based-automation></span>
<a href=#setting-up-webhook-based-automation class=subheading-anchor aria-label="Permalink for this section"></a></h3><div class="hextra-code-block hx:relative hx:mt-6 hx:first:mt-0 hx:group/code"><div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#75715e>// workflow-manager.js
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>express</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#39;express&#39;</span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> { <span style=color:#a6e22e>WorkflowEngine</span> } <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#39;@bigledger/workflow-sdk&#39;</span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> { <span style=color:#a6e22e>BigLedgerClient</span> } <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#39;@bigledger/sdk&#39;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>AutomationManager</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>constructor</span>() {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>workflowEngine</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>WorkflowEngine</span>({
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>apiKey</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>process</span>.<span style=color:#a6e22e>env</span>.<span style=color:#a6e22e>BIGLEDGER_API_KEY</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>companyId</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>process</span>.<span style=color:#a6e22e>env</span>.<span style=color:#a6e22e>BIGLEDGER_COMPANY_ID</span>
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>bigledger</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>BigLedgerClient</span>({
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>apiKey</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>process</span>.<span style=color:#a6e22e>env</span>.<span style=color:#a6e22e>BIGLEDGER_API_KEY</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>companyId</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>process</span>.<span style=color:#a6e22e>env</span>.<span style=color:#a6e22e>BIGLEDGER_COMPANY_ID</span>
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>async</span> <span style=color:#a6e22e>setupWebhookHandlers</span>() {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Invoice automation workflows
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>workflowEngine</span>.<span style=color:#a6e22e>on</span>(<span style=color:#e6db74>&#39;invoice.created&#39;</span>, <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>handleInvoiceCreated</span>.<span style=color:#a6e22e>bind</span>(<span style=color:#66d9ef>this</span>));
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>workflowEngine</span>.<span style=color:#a6e22e>on</span>(<span style=color:#e6db74>&#39;invoice.overdue&#39;</span>, <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>handleOverdueInvoice</span>.<span style=color:#a6e22e>bind</span>(<span style=color:#66d9ef>this</span>));
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>workflowEngine</span>.<span style=color:#a6e22e>on</span>(<span style=color:#e6db74>&#39;payment.received&#39;</span>, <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>handlePaymentReceived</span>.<span style=color:#a6e22e>bind</span>(<span style=color:#66d9ef>this</span>));
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Inventory automation workflows
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>workflowEngine</span>.<span style=color:#a6e22e>on</span>(<span style=color:#e6db74>&#39;inventory.low_stock&#39;</span>, <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>handleLowStock</span>.<span style=color:#a6e22e>bind</span>(<span style=color:#66d9ef>this</span>));
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>workflowEngine</span>.<span style=color:#a6e22e>on</span>(<span style=color:#e6db74>&#39;inventory.out_of_stock&#39;</span>, <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>handleOutOfStock</span>.<span style=color:#a6e22e>bind</span>(<span style=color:#66d9ef>this</span>));
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Purchase automation workflows
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>workflowEngine</span>.<span style=color:#a6e22e>on</span>(<span style=color:#e6db74>&#39;purchase_order.approved&#39;</span>, <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>handlePurchaseOrderApproved</span>.<span style=color:#a6e22e>bind</span>(<span style=color:#66d9ef>this</span>));
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>workflowEngine</span>.<span style=color:#a6e22e>on</span>(<span style=color:#e6db74>&#39;bill.received&#39;</span>, <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>handleBillReceived</span>.<span style=color:#a6e22e>bind</span>(<span style=color:#66d9ef>this</span>));
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>async</span> <span style=color:#a6e22e>handleInvoiceCreated</span>(<span style=color:#a6e22e>event</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>invoice</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>event</span>.<span style=color:#a6e22e>data</span>.<span style=color:#a6e22e>object</span>;
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Start automated invoice processing workflow
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>workflowEngine</span>.<span style=color:#a6e22e>startWorkflow</span>(<span style=color:#e6db74>&#39;invoice-processing&#39;</span>, {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>invoiceId</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>invoice</span>.<span style=color:#a6e22e>id</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>customerId</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>invoice</span>.<span style=color:#a6e22e>customerId</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>amount</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>invoice</span>.<span style=color:#a6e22e>total</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>priority</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>invoice</span>.<span style=color:#a6e22e>total</span> <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>10000</span> <span style=color:#f92672>?</span> <span style=color:#e6db74>&#39;high&#39;</span> <span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;normal&#39;</span>
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>async</span> <span style=color:#a6e22e>handleOverdueInvoice</span>(<span style=color:#a6e22e>event</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>invoice</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>event</span>.<span style=color:#a6e22e>data</span>.<span style=color:#a6e22e>object</span>;
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Start automated dunning process
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>workflowEngine</span>.<span style=color:#a6e22e>startWorkflow</span>(<span style=color:#e6db74>&#39;dunning-process&#39;</span>, {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>invoiceId</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>invoice</span>.<span style=color:#a6e22e>id</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>customerId</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>invoice</span>.<span style=color:#a6e22e>customerId</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>overdueAmount</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>invoice</span>.<span style=color:#a6e22e>amountDue</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>overdueDays</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>invoice</span>.<span style=color:#a6e22e>overdueDays</span>
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}</span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx:opacity-0 hx:transition hx:group-hover/code:opacity-100 hx:flex hx:gap-1 hx:absolute hx:m-[11px] hx:right-0 hx:top-0"><button class="hextra-code-copy-btn hx:group/copybtn hx:cursor-pointer hx:transition-all hx:active:opacity-50 hx:bg-primary-700/5 hx:border hx:border-black/5 hx:text-gray-600 hx:hover:text-gray-900 hx:rounded-md hx:p-1.5 hx:dark:bg-primary-300/10 hx:dark:border-white/10 hx:dark:text-gray-400 hx:dark:hover:text-gray-50" title="Copy code"><div class="copy-icon hx:group-[.copied]/copybtn:hidden hx:pointer-events-none hx:h-4 hx:w-4"></div><div class="success-icon hx:hidden hx:group-[.copied]/copybtn:block hx:pointer-events-none hx:h-4 hx:w-4"></div></button></div></div><h3>Complex Workflow Example: Invoice Processing<span class="hx:absolute hx:-mt-20" id=complex-workflow-example-invoice-processing></span>
<a href=#complex-workflow-example-invoice-processing class=subheading-anchor aria-label="Permalink for this section"></a></h3><div class="hextra-code-block hx:relative hx:mt-6 hx:first:mt-0 hx:group/code"><div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#75715e>// workflows/invoice-processing.js
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>InvoiceProcessingWorkflow</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>constructor</span>(<span style=color:#a6e22e>workflowContext</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>context</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>workflowContext</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>bigledger</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>workflowContext</span>.<span style=color:#a6e22e>bigledger</span>;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>async</span> <span style=color:#a6e22e>execute</span>() {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> { <span style=color:#a6e22e>invoiceId</span>, <span style=color:#a6e22e>customerId</span>, <span style=color:#a6e22e>amount</span>, <span style=color:#a6e22e>priority</span> } <span style=color:#f92672>=</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>input</span>;
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>      <span style=color:#75715e>// Step 1: Validate invoice data
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>validateInvoiceData</span>(<span style=color:#a6e22e>invoiceId</span>);
</span></span><span style=display:flex><span>      
</span></span><span style=display:flex><span>      <span style=color:#75715e>// Step 2: Check customer credit limit
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>creditCheck</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>checkCustomerCredit</span>(<span style=color:#a6e22e>customerId</span>, <span style=color:#a6e22e>amount</span>);
</span></span><span style=display:flex><span>      
</span></span><span style=display:flex><span>      <span style=color:#75715e>// Step 3: Apply business rules
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>businessRules</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>applyBusinessRules</span>(<span style=color:#a6e22e>invoiceId</span>, <span style=color:#a6e22e>creditCheck</span>);
</span></span><span style=display:flex><span>      
</span></span><span style=display:flex><span>      <span style=color:#75715e>// Step 4: Generate e-invoice if required
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>businessRules</span>.<span style=color:#a6e22e>requiresEInvoice</span>) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>generateEInvoice</span>(<span style=color:#a6e22e>invoiceId</span>);
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>      
</span></span><span style=display:flex><span>      <span style=color:#75715e>// Step 5: Send invoice to customer
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>sendInvoiceToCustomer</span>(<span style=color:#a6e22e>invoiceId</span>, <span style=color:#a6e22e>businessRules</span>.<span style=color:#a6e22e>deliveryMethod</span>);
</span></span><span style=display:flex><span>      
</span></span><span style=display:flex><span>      <span style=color:#75715e>// Step 6: Schedule follow-up actions
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>scheduleFollowUpActions</span>(<span style=color:#a6e22e>invoiceId</span>, <span style=color:#a6e22e>businessRules</span>);
</span></span><span style=display:flex><span>      
</span></span><span style=display:flex><span>      <span style=color:#75715e>// Step 7: Update CRM and analytics
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>updateCRMAndAnalytics</span>(<span style=color:#a6e22e>customerId</span>, <span style=color:#a6e22e>invoiceId</span>);
</span></span><span style=display:flex><span>      
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> { <span style=color:#a6e22e>status</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;completed&#39;</span>, <span style=color:#a6e22e>invoiceId</span>, <span style=color:#a6e22e>actions</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>businessRules</span>.<span style=color:#a6e22e>actions</span> };
</span></span><span style=display:flex><span>      
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>catch</span> (<span style=color:#a6e22e>error</span>) {
</span></span><span style=display:flex><span>      <span style=color:#75715e>// Handle errors and trigger remediation workflows
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>handleWorkflowError</span>(<span style=color:#a6e22e>error</span>, <span style=color:#a6e22e>invoiceId</span>);
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>throw</span> <span style=color:#a6e22e>error</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>async</span> <span style=color:#a6e22e>validateInvoiceData</span>(<span style=color:#a6e22e>invoiceId</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>invoice</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>bigledger</span>.<span style=color:#a6e22e>invoices</span>.<span style=color:#a6e22e>get</span>(<span style=color:#a6e22e>invoiceId</span>);
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>validations</span> <span style=color:#f92672>=</span> [
</span></span><span style=display:flex><span>      { <span style=color:#a6e22e>field</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;items&#39;</span>, <span style=color:#a6e22e>check</span><span style=color:#f92672>:</span> (<span style=color:#a6e22e>inv</span>) =&gt; <span style=color:#a6e22e>inv</span>.<span style=color:#a6e22e>items</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>inv</span>.<span style=color:#a6e22e>items</span>.<span style=color:#a6e22e>length</span> <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>0</span> },
</span></span><span style=display:flex><span>      { <span style=color:#a6e22e>field</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;customer&#39;</span>, <span style=color:#a6e22e>check</span><span style=color:#f92672>:</span> (<span style=color:#a6e22e>inv</span>) =&gt; <span style=color:#a6e22e>inv</span>.<span style=color:#a6e22e>customerId</span> },
</span></span><span style=display:flex><span>      { <span style=color:#a6e22e>field</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;total&#39;</span>, <span style=color:#a6e22e>check</span><span style=color:#f92672>:</span> (<span style=color:#a6e22e>inv</span>) =&gt; <span style=color:#a6e22e>inv</span>.<span style=color:#a6e22e>total</span> <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>0</span> },
</span></span><span style=display:flex><span>      { <span style=color:#a6e22e>field</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;dueDate&#39;</span>, <span style=color:#a6e22e>check</span><span style=color:#f92672>:</span> (<span style=color:#a6e22e>inv</span>) =&gt; <span style=color:#a6e22e>inv</span>.<span style=color:#a6e22e>dueDate</span> }
</span></span><span style=display:flex><span>    ];
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>errors</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>validations</span>
</span></span><span style=display:flex><span>      .<span style=color:#a6e22e>filter</span>(<span style=color:#a6e22e>v</span> =&gt; <span style=color:#f92672>!</span><span style=color:#a6e22e>v</span>.<span style=color:#a6e22e>check</span>(<span style=color:#a6e22e>invoice</span>))
</span></span><span style=display:flex><span>      .<span style=color:#a6e22e>map</span>(<span style=color:#a6e22e>v</span> =&gt; <span style=color:#e6db74>`Missing or invalid: </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>v</span>.<span style=color:#a6e22e>field</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>errors</span>.<span style=color:#a6e22e>length</span> <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>0</span>) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>throw</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>ValidationError</span>(<span style=color:#e6db74>`Invoice validation failed: </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>errors</span>.<span style=color:#a6e22e>join</span>(<span style=color:#e6db74>&#39;, &#39;</span>)<span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>async</span> <span style=color:#a6e22e>checkCustomerCredit</span>(<span style=color:#a6e22e>customerId</span>, <span style=color:#a6e22e>amount</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>customer</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>bigledger</span>.<span style=color:#a6e22e>customers</span>.<span style=color:#a6e22e>get</span>(<span style=color:#a6e22e>customerId</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>outstandingBalance</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>bigledger</span>.<span style=color:#a6e22e>customers</span>.<span style=color:#a6e22e>getOutstandingBalance</span>(<span style=color:#a6e22e>customerId</span>);
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>creditLimit</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>customer</span>.<span style=color:#a6e22e>creditLimit</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>currentBalance</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>outstandingBalance</span>.<span style=color:#a6e22e>total</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>newBalance</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>outstandingBalance</span>.<span style=color:#a6e22e>total</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>amount</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>withinLimit</span><span style=color:#f92672>:</span> (<span style=color:#a6e22e>outstandingBalance</span>.<span style=color:#a6e22e>total</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>amount</span>) <span style=color:#f92672>&lt;=</span> <span style=color:#a6e22e>customer</span>.<span style=color:#a6e22e>creditLimit</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>riskLevel</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>calculateRiskLevel</span>(<span style=color:#a6e22e>customer</span>, <span style=color:#a6e22e>outstandingBalance</span>.<span style=color:#a6e22e>total</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>amount</span>)
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>async</span> <span style=color:#a6e22e>applyBusinessRules</span>(<span style=color:#a6e22e>invoiceId</span>, <span style=color:#a6e22e>creditCheck</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>invoice</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>bigledger</span>.<span style=color:#a6e22e>invoices</span>.<span style=color:#a6e22e>get</span>(<span style=color:#a6e22e>invoiceId</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>customer</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>bigledger</span>.<span style=color:#a6e22e>customers</span>.<span style=color:#a6e22e>get</span>(<span style=color:#a6e22e>invoice</span>.<span style=color:#a6e22e>customerId</span>);
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>rules</span> <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>requiresEInvoice</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>customer</span>.<span style=color:#a6e22e>country</span> <span style=color:#f92672>===</span> <span style=color:#e6db74>&#39;MY&#39;</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>invoice</span>.<span style=color:#a6e22e>total</span> <span style=color:#f92672>&gt;=</span> <span style=color:#ae81ff>100</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>requiresApproval</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>creditCheck</span>.<span style=color:#a6e22e>riskLevel</span> <span style=color:#f92672>===</span> <span style=color:#e6db74>&#39;high&#39;</span> <span style=color:#f92672>||</span> <span style=color:#a6e22e>invoice</span>.<span style=color:#a6e22e>total</span> <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>50000</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>deliveryMethod</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>customer</span>.<span style=color:#a6e22e>preferences</span><span style=color:#f92672>?</span>.<span style=color:#a6e22e>invoiceDelivery</span> <span style=color:#f92672>||</span> <span style=color:#e6db74>&#39;email&#39;</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>paymentTerms</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>calculatePaymentTerms</span>(<span style=color:#a6e22e>customer</span>, <span style=color:#a6e22e>creditCheck</span>),
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>actions</span><span style=color:#f92672>:</span> []
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Apply conditional logic
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>creditCheck</span>.<span style=color:#a6e22e>withinLimit</span>) {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>rules</span>.<span style=color:#a6e22e>requiresApproval</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>;
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>rules</span>.<span style=color:#a6e22e>actions</span>.<span style=color:#a6e22e>push</span>({
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>type</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;credit_limit_exceeded_notification&#39;</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>recipients</span><span style=color:#f92672>:</span> [<span style=color:#e6db74>&#39;credit_manager@company.com&#39;</span>],
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>data</span><span style=color:#f92672>:</span> { <span style=color:#a6e22e>customerId</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>customer</span>.<span style=color:#a6e22e>id</span>, <span style=color:#a6e22e>exceedAmount</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>creditCheck</span>.<span style=color:#a6e22e>newBalance</span> <span style=color:#f92672>-</span> <span style=color:#a6e22e>creditCheck</span>.<span style=color:#a6e22e>creditLimit</span> }
</span></span><span style=display:flex><span>      });
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>invoice</span>.<span style=color:#a6e22e>total</span> <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>25000</span>) {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>rules</span>.<span style=color:#a6e22e>actions</span>.<span style=color:#a6e22e>push</span>({
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>type</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;high_value_invoice_notification&#39;</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>recipients</span><span style=color:#f92672>:</span> [<span style=color:#e6db74>&#39;finance_director@company.com&#39;</span>],
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>data</span><span style=color:#f92672>:</span> { <span style=color:#a6e22e>invoiceId</span>, <span style=color:#a6e22e>amount</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>invoice</span>.<span style=color:#a6e22e>total</span> }
</span></span><span style=display:flex><span>      });
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>rules</span>;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>async</span> <span style=color:#a6e22e>generateEInvoice</span>(<span style=color:#a6e22e>invoiceId</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>einvoice</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>bigledger</span>.<span style=color:#a6e22e>einvoice</span>.<span style=color:#a6e22e>create</span>({
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>invoiceId</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>format</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;PEPPOL_UBL&#39;</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>autoSubmit</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>      });
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#75715e>// Monitor e-invoice status
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>scheduleTask</span>(<span style=color:#e6db74>&#39;monitor-einvoice-status&#39;</span>, {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>einvoiceId</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>einvoice</span>.<span style=color:#a6e22e>id</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>maxAttempts</span><span style=color:#f92672>:</span> <span style=color:#ae81ff>10</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>intervalMinutes</span><span style=color:#f92672>:</span> <span style=color:#ae81ff>5</span>
</span></span><span style=display:flex><span>      });
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>einvoice</span>;
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>catch</span> (<span style=color:#a6e22e>error</span>) {
</span></span><span style=display:flex><span>      <span style=color:#75715e>// Handle e-invoice generation errors
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>createTask</span>(<span style=color:#e6db74>&#39;einvoice-manual-review&#39;</span>, {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>invoiceId</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>error</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>error</span>.<span style=color:#a6e22e>message</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>assignee</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;compliance_team&#39;</span>
</span></span><span style=display:flex><span>      });
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>throw</span> <span style=color:#a6e22e>error</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>async</span> <span style=color:#a6e22e>sendInvoiceToCustomer</span>(<span style=color:#a6e22e>invoiceId</span>, <span style=color:#a6e22e>deliveryMethod</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>methods</span> <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>email</span><span style=color:#f92672>:</span> () =&gt; <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>sendInvoiceByEmail</span>(<span style=color:#a6e22e>invoiceId</span>),
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>portal</span><span style=color:#f92672>:</span> () =&gt; <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>publishToCustomerPortal</span>(<span style=color:#a6e22e>invoiceId</span>),
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>api</span><span style=color:#f92672>:</span> () =&gt; <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>sendViaCustomerAPI</span>(<span style=color:#a6e22e>invoiceId</span>),
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>postal</span><span style=color:#f92672>:</span> () =&gt; <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>schedulePostalDelivery</span>(<span style=color:#a6e22e>invoiceId</span>)
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>methods</span>[<span style=color:#a6e22e>deliveryMethod</span>]) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>methods</span>[<span style=color:#a6e22e>deliveryMethod</span>]();
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>      <span style=color:#75715e>// Default to email
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>sendInvoiceByEmail</span>(<span style=color:#a6e22e>invoiceId</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>async</span> <span style=color:#a6e22e>scheduleFollowUpActions</span>(<span style=color:#a6e22e>invoiceId</span>, <span style=color:#a6e22e>businessRules</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>invoice</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>bigledger</span>.<span style=color:#a6e22e>invoices</span>.<span style=color:#a6e22e>get</span>(<span style=color:#a6e22e>invoiceId</span>);
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Schedule payment reminder
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>reminderDate</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> Date(<span style=color:#a6e22e>invoice</span>.<span style=color:#a6e22e>dueDate</span>);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>reminderDate</span>.<span style=color:#a6e22e>setDate</span>(<span style=color:#a6e22e>reminderDate</span>.<span style=color:#a6e22e>getDate</span>() <span style=color:#f92672>-</span> <span style=color:#ae81ff>3</span>); <span style=color:#75715e>// 3 days before due
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>scheduleWorkflow</span>(<span style=color:#e6db74>&#39;payment-reminder&#39;</span>, {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>invoiceId</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>customerId</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>invoice</span>.<span style=color:#a6e22e>customerId</span>
</span></span><span style=display:flex><span>    }, <span style=color:#a6e22e>reminderDate</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Schedule overdue follow-up
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>overdueDate</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> Date(<span style=color:#a6e22e>invoice</span>.<span style=color:#a6e22e>dueDate</span>);
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>overdueDate</span>.<span style=color:#a6e22e>setDate</span>(<span style=color:#a6e22e>overdueDate</span>.<span style=color:#a6e22e>getDate</span>() <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>); <span style=color:#75715e>// 1 day after due
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>scheduleWorkflow</span>(<span style=color:#e6db74>&#39;overdue-follow-up&#39;</span>, {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>invoiceId</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>customerId</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>invoice</span>.<span style=color:#a6e22e>customerId</span>
</span></span><span style=display:flex><span>    }, <span style=color:#a6e22e>overdueDate</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}</span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx:opacity-0 hx:transition hx:group-hover/code:opacity-100 hx:flex hx:gap-1 hx:absolute hx:m-[11px] hx:right-0 hx:top-0"><button class="hextra-code-copy-btn hx:group/copybtn hx:cursor-pointer hx:transition-all hx:active:opacity-50 hx:bg-primary-700/5 hx:border hx:border-black/5 hx:text-gray-600 hx:hover:text-gray-900 hx:rounded-md hx:p-1.5 hx:dark:bg-primary-300/10 hx:dark:border-white/10 hx:dark:text-gray-400 hx:dark:hover:text-gray-50" title="Copy code"><div class="copy-icon hx:group-[.copied]/copybtn:hidden hx:pointer-events-none hx:h-4 hx:w-4"></div><div class="success-icon hx:hidden hx:group-[.copied]/copybtn:block hx:pointer-events-none hx:h-4 hx:w-4"></div></button></div></div><h2>Business Rule Engine<span class="hx:absolute hx:-mt-20" id=business-rule-engine></span>
<a href=#business-rule-engine class=subheading-anchor aria-label="Permalink for this section"></a></h2><h3>Defining Business Rules<span class="hx:absolute hx:-mt-20" id=defining-business-rules></span>
<a href=#defining-business-rules class=subheading-anchor aria-label="Permalink for this section"></a></h3><div class="hextra-code-block hx:relative hx:mt-6 hx:first:mt-0 hx:group/code"><div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#75715e>// business-rules/invoice-rules.js
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>const</span> { <span style=color:#a6e22e>RuleEngine</span> } <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#39;@bigledger/workflow-sdk&#39;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>InvoiceBusinessRules</span> <span style=color:#66d9ef>extends</span> <span style=color:#a6e22e>RuleEngine</span> {
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>constructor</span>() {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>super</span>();
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>defineRules</span>();
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>defineRules</span>() {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Rule: High-value invoice approval
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>addRule</span>(<span style=color:#e6db74>&#39;high-value-approval&#39;</span>, {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>when</span><span style=color:#f92672>:</span> (<span style=color:#a6e22e>facts</span>) =&gt; <span style=color:#a6e22e>facts</span>.<span style=color:#a6e22e>invoice</span>.<span style=color:#a6e22e>total</span> <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>50000</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>then</span><span style=color:#f92672>:</span> (<span style=color:#a6e22e>facts</span>, <span style=color:#a6e22e>actions</span>) =&gt; {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>actions</span>.<span style=color:#a6e22e>requireApproval</span>({
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>approvers</span><span style=color:#f92672>:</span> [<span style=color:#e6db74>&#39;finance_director&#39;</span>, <span style=color:#e6db74>&#39;ceo&#39;</span>],
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>reason</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;High value invoice requires executive approval&#39;</span>
</span></span><span style=display:flex><span>        });
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Rule: New customer credit check
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>addRule</span>(<span style=color:#e6db74>&#39;new-customer-credit-check&#39;</span>, {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>when</span><span style=color:#f92672>:</span> (<span style=color:#a6e22e>facts</span>) =&gt; <span style=color:#a6e22e>facts</span>.<span style=color:#a6e22e>customer</span>.<span style=color:#a6e22e>isNew</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>facts</span>.<span style=color:#a6e22e>invoice</span>.<span style=color:#a6e22e>total</span> <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>5000</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>then</span><span style=color:#f92672>:</span> (<span style=color:#a6e22e>facts</span>, <span style=color:#a6e22e>actions</span>) =&gt; {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>actions</span>.<span style=color:#a6e22e>requireCreditCheck</span>({
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>customerId</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>facts</span>.<span style=color:#a6e22e>customer</span>.<span style=color:#a6e22e>id</span>,
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>requestedAmount</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>facts</span>.<span style=color:#a6e22e>invoice</span>.<span style=color:#a6e22e>total</span>
</span></span><span style=display:flex><span>        });
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Rule: Multi-currency invoice validation
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>addRule</span>(<span style=color:#e6db74>&#39;multi-currency-validation&#39;</span>, {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>when</span><span style=color:#f92672>:</span> (<span style=color:#a6e22e>facts</span>) =&gt; <span style=color:#a6e22e>facts</span>.<span style=color:#a6e22e>invoice</span>.<span style=color:#a6e22e>currency</span> <span style=color:#f92672>!==</span> <span style=color:#a6e22e>facts</span>.<span style=color:#a6e22e>company</span>.<span style=color:#a6e22e>baseCurrency</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>then</span><span style=color:#f92672>:</span> (<span style=color:#a6e22e>facts</span>, <span style=color:#a6e22e>actions</span>) =&gt; {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>actions</span>.<span style=color:#a6e22e>validateExchangeRate</span>({
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>fromCurrency</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>facts</span>.<span style=color:#a6e22e>invoice</span>.<span style=color:#a6e22e>currency</span>,
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>toCurrency</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>facts</span>.<span style=color:#a6e22e>company</span>.<span style=color:#a6e22e>baseCurrency</span>,
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>amount</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>facts</span>.<span style=color:#a6e22e>invoice</span>.<span style=color:#a6e22e>total</span>,
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>date</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>facts</span>.<span style=color:#a6e22e>invoice</span>.<span style=color:#a6e22e>invoiceDate</span>
</span></span><span style=display:flex><span>        });
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Rule: Automatic discount application
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>addRule</span>(<span style=color:#e6db74>&#39;volume-discount&#39;</span>, {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>when</span><span style=color:#f92672>:</span> (<span style=color:#a6e22e>facts</span>) =&gt; <span style=color:#a6e22e>facts</span>.<span style=color:#a6e22e>customer</span>.<span style=color:#a6e22e>tier</span> <span style=color:#f92672>===</span> <span style=color:#e6db74>&#39;premium&#39;</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>facts</span>.<span style=color:#a6e22e>invoice</span>.<span style=color:#a6e22e>total</span> <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>10000</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>then</span><span style=color:#f92672>:</span> (<span style=color:#a6e22e>facts</span>, <span style=color:#a6e22e>actions</span>) =&gt; {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>actions</span>.<span style=color:#a6e22e>applyDiscount</span>({
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>type</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;percentage&#39;</span>,
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>value</span><span style=color:#f92672>:</span> <span style=color:#ae81ff>5</span>,
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>reason</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;Premium customer volume discount&#39;</span>
</span></span><span style=display:flex><span>        });
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Rule: Tax validation
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>addRule</span>(<span style=color:#e6db74>&#39;tax-validation&#39;</span>, {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>when</span><span style=color:#f92672>:</span> (<span style=color:#a6e22e>facts</span>) =&gt; <span style=color:#a6e22e>facts</span>.<span style=color:#a6e22e>invoice</span>.<span style=color:#a6e22e>items</span>.<span style=color:#a6e22e>some</span>(<span style=color:#a6e22e>item</span> =&gt; <span style=color:#f92672>!</span><span style=color:#a6e22e>item</span>.<span style=color:#a6e22e>taxCode</span>),
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>then</span><span style=color:#f92672>:</span> (<span style=color:#a6e22e>facts</span>, <span style=color:#a6e22e>actions</span>) =&gt; {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>actions</span>.<span style=color:#a6e22e>flagForTaxReview</span>({
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>invoiceId</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>facts</span>.<span style=color:#a6e22e>invoice</span>.<span style=color:#a6e22e>id</span>,
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>reason</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;Missing tax codes on line items&#39;</span>
</span></span><span style=display:flex><span>        });
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>async</span> <span style=color:#a6e22e>executeRules</span>(<span style=color:#a6e22e>invoiceData</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>facts</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>prepareFacts</span>(<span style=color:#a6e22e>invoiceData</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>results</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>run</span>(<span style=color:#a6e22e>facts</span>);
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>rules_applied</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>results</span>.<span style=color:#a6e22e>events</span>.<span style=color:#a6e22e>map</span>(<span style=color:#a6e22e>e</span> =&gt; <span style=color:#a6e22e>e</span>.<span style=color:#a6e22e>type</span>),
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>actions_required</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>results</span>.<span style=color:#a6e22e>events</span>.<span style=color:#a6e22e>map</span>(<span style=color:#a6e22e>e</span> =&gt; <span style=color:#a6e22e>e</span>.<span style=color:#a6e22e>params</span>),
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>approval_required</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>results</span>.<span style=color:#a6e22e>events</span>.<span style=color:#a6e22e>some</span>(<span style=color:#a6e22e>e</span> =&gt; <span style=color:#a6e22e>e</span>.<span style=color:#a6e22e>type</span> <span style=color:#f92672>===</span> <span style=color:#e6db74>&#39;requireApproval&#39;</span>),
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>warnings</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>results</span>.<span style=color:#a6e22e>events</span>.<span style=color:#a6e22e>filter</span>(<span style=color:#a6e22e>e</span> =&gt; <span style=color:#a6e22e>e</span>.<span style=color:#a6e22e>type</span>.<span style=color:#a6e22e>includes</span>(<span style=color:#e6db74>&#39;warning&#39;</span>)),
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>errors</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>results</span>.<span style=color:#a6e22e>events</span>.<span style=color:#a6e22e>filter</span>(<span style=color:#a6e22e>e</span> =&gt; <span style=color:#a6e22e>e</span>.<span style=color:#a6e22e>type</span>.<span style=color:#a6e22e>includes</span>(<span style=color:#e6db74>&#39;error&#39;</span>))
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>async</span> <span style=color:#a6e22e>prepareFacts</span>(<span style=color:#a6e22e>invoiceData</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>invoice</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>bigledger</span>.<span style=color:#a6e22e>invoices</span>.<span style=color:#a6e22e>get</span>(<span style=color:#a6e22e>invoiceData</span>.<span style=color:#a6e22e>invoiceId</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>customer</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>bigledger</span>.<span style=color:#a6e22e>customers</span>.<span style=color:#a6e22e>get</span>(<span style=color:#a6e22e>invoice</span>.<span style=color:#a6e22e>customerId</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>company</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>bigledger</span>.<span style=color:#a6e22e>company</span>.<span style=color:#a6e22e>get</span>();
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>invoice</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>        ...<span style=color:#a6e22e>invoice</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>isNew</span><span style=color:#f92672>:</span> <span style=color:#f92672>!</span><span style=color:#a6e22e>invoice</span>.<span style=color:#a6e22e>invoiceNumber</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>age</span><span style=color:#f92672>:</span> Math.<span style=color:#a6e22e>floor</span>((Date.<span style=color:#a6e22e>now</span>() <span style=color:#f92672>-</span> <span style=color:#66d9ef>new</span> Date(<span style=color:#a6e22e>invoice</span>.<span style=color:#a6e22e>createdAt</span>)) <span style=color:#f92672>/</span> (<span style=color:#ae81ff>1000</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>60</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>60</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>24</span>))
</span></span><span style=display:flex><span>      },
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>customer</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>        ...<span style=color:#a6e22e>customer</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>isNew</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>customer</span>.<span style=color:#a6e22e>createdAt</span> <span style=color:#f92672>&gt;</span> Date.<span style=color:#a6e22e>now</span>() <span style=color:#f92672>-</span> (<span style=color:#ae81ff>30</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>24</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>60</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>60</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>1000</span>), <span style=color:#75715e>// 30 days
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#a6e22e>outstandingBalance</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>getCustomerBalance</span>(<span style=color:#a6e22e>customer</span>.<span style=color:#a6e22e>id</span>)
</span></span><span style=display:flex><span>      },
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>company</span>
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}</span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx:opacity-0 hx:transition hx:group-hover/code:opacity-100 hx:flex hx:gap-1 hx:absolute hx:m-[11px] hx:right-0 hx:top-0"><button class="hextra-code-copy-btn hx:group/copybtn hx:cursor-pointer hx:transition-all hx:active:opacity-50 hx:bg-primary-700/5 hx:border hx:border-black/5 hx:text-gray-600 hx:hover:text-gray-900 hx:rounded-md hx:p-1.5 hx:dark:bg-primary-300/10 hx:dark:border-white/10 hx:dark:text-gray-400 hx:dark:hover:text-gray-50" title="Copy code"><div class="copy-icon hx:group-[.copied]/copybtn:hidden hx:pointer-events-none hx:h-4 hx:w-4"></div><div class="success-icon hx:hidden hx:group-[.copied]/copybtn:block hx:pointer-events-none hx:h-4 hx:w-4"></div></button></div></div><h2>Scheduled Automation<span class="hx:absolute hx:-mt-20" id=scheduled-automation></span>
<a href=#scheduled-automation class=subheading-anchor aria-label="Permalink for this section"></a></h2><h3>Automated Report Generation<span class="hx:absolute hx:-mt-20" id=automated-report-generation></span>
<a href=#automated-report-generation class=subheading-anchor aria-label="Permalink for this section"></a></h3><div class="hextra-code-block hx:relative hx:mt-6 hx:first:mt-0 hx:group/code"><div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#75715e>// schedulers/report-scheduler.js
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>cron</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#39;node-cron&#39;</span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> { <span style=color:#a6e22e>ReportGenerator</span> } <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#39;@bigledger/reporting-sdk&#39;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>AutomatedReportScheduler</span> {
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>constructor</span>() {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>reportGenerator</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>ReportGenerator</span>({
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>apiKey</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>process</span>.<span style=color:#a6e22e>env</span>.<span style=color:#a6e22e>BIGLEDGER_API_KEY</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>companyId</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>process</span>.<span style=color:#a6e22e>env</span>.<span style=color:#a6e22e>BIGLEDGER_COMPANY_ID</span>
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>start</span>() {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Daily reports
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>cron</span>.<span style=color:#a6e22e>schedule</span>(<span style=color:#e6db74>&#39;0 9 * * 1-5&#39;</span>, () =&gt; {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>generateDailyReports</span>();
</span></span><span style=display:flex><span>    }, { <span style=color:#a6e22e>timezone</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;Asia/Kuala_Lumpur&#39;</span> });
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Weekly reports  
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>cron</span>.<span style=color:#a6e22e>schedule</span>(<span style=color:#e6db74>&#39;0 10 * * 1&#39;</span>, () =&gt; {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>generateWeeklyReports</span>();
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Monthly reports
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>cron</span>.<span style=color:#a6e22e>schedule</span>(<span style=color:#e6db74>&#39;0 9 1 * *&#39;</span>, () =&gt; {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>generateMonthlyReports</span>();
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// End-of-quarter reports
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>cron</span>.<span style=color:#a6e22e>schedule</span>(<span style=color:#e6db74>&#39;0 8 1 1,4,7,10 *&#39;</span>, () =&gt; {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>generateQuarterlyReports</span>();
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>async</span> <span style=color:#a6e22e>generateDailyReports</span>() {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>yesterday</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> Date();
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>yesterday</span>.<span style=color:#a6e22e>setDate</span>(<span style=color:#a6e22e>yesterday</span>.<span style=color:#a6e22e>getDate</span>() <span style=color:#f92672>-</span> <span style=color:#ae81ff>1</span>);
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>reports</span> <span style=color:#f92672>=</span> [
</span></span><span style=display:flex><span>      {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>name</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;Daily Sales Summary&#39;</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>type</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;sales_summary&#39;</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>dateRange</span><span style=color:#f92672>:</span> { <span style=color:#a6e22e>from</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>yesterday</span>, <span style=color:#a6e22e>to</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>yesterday</span> },
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>recipients</span><span style=color:#f92672>:</span> [<span style=color:#e6db74>&#39;sales@company.com&#39;</span>, <span style=color:#e6db74>&#39;management@company.com&#39;</span>]
</span></span><span style=display:flex><span>      },
</span></span><span style=display:flex><span>      {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>name</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;Cash Flow Report&#39;</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>type</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;cash_flow&#39;</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>dateRange</span><span style=color:#f92672>:</span> { <span style=color:#a6e22e>from</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>yesterday</span>, <span style=color:#a6e22e>to</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>yesterday</span> },
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>recipients</span><span style=color:#f92672>:</span> [<span style=color:#e6db74>&#39;finance@company.com&#39;</span>]
</span></span><span style=display:flex><span>      },
</span></span><span style=display:flex><span>      {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>name</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;Outstanding Invoices&#39;</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>type</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;aged_receivables&#39;</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>asOfDate</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>yesterday</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>recipients</span><span style=color:#f92672>:</span> [<span style=color:#e6db74>&#39;accounts@company.com&#39;</span>]
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    ];
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>const</span> <span style=color:#a6e22e>reportConfig</span> <span style=color:#66d9ef>of</span> <span style=color:#a6e22e>reports</span>) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>generateAndDistributeReport</span>(<span style=color:#a6e22e>reportConfig</span>);
</span></span><span style=display:flex><span>      } <span style=color:#66d9ef>catch</span> (<span style=color:#a6e22e>error</span>) {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>error</span>(<span style=color:#e6db74>`Failed to generate </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>reportConfig</span>.<span style=color:#a6e22e>name</span><span style=color:#e6db74>}</span><span style=color:#e6db74>:`</span>, <span style=color:#a6e22e>error</span>);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>notifyReportFailure</span>(<span style=color:#a6e22e>reportConfig</span>, <span style=color:#a6e22e>error</span>);
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>async</span> <span style=color:#a6e22e>generateWeeklyReports</span>() {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>lastWeek</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>getLastWeekRange</span>();
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>reports</span> <span style=color:#f92672>=</span> [
</span></span><span style=display:flex><span>      {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>name</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;Weekly Financial Summary&#39;</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>type</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;financial_summary&#39;</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>dateRange</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>lastWeek</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>recipients</span><span style=color:#f92672>:</span> [<span style=color:#e6db74>&#39;ceo@company.com&#39;</span>, <span style=color:#e6db74>&#39;cfo@company.com&#39;</span>],
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>format</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;pdf&#39;</span>
</span></span><span style=display:flex><span>      },
</span></span><span style=display:flex><span>      {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>name</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;Inventory Movement Report&#39;</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>type</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;inventory_movement&#39;</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>dateRange</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>lastWeek</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>recipients</span><span style=color:#f92672>:</span> [<span style=color:#e6db74>&#39;warehouse@company.com&#39;</span>, <span style=color:#e6db74>&#39;purchasing@company.com&#39;</span>]
</span></span><span style=display:flex><span>      },
</span></span><span style=display:flex><span>      {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>name</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;Customer Payment Analysis&#39;</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>type</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;payment_analysis&#39;</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>dateRange</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>lastWeek</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>recipients</span><span style=color:#f92672>:</span> [<span style=color:#e6db74>&#39;credit_control@company.com&#39;</span>]
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    ];
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>processReportsInBatch</span>(<span style=color:#a6e22e>reports</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>async</span> <span style=color:#a6e22e>generateAndDistributeReport</span>(<span style=color:#a6e22e>config</span>) {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Generate the report
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>report</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>reportGenerator</span>.<span style=color:#a6e22e>generate</span>({
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>type</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>config</span>.<span style=color:#a6e22e>type</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>parameters</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>dateRange</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>config</span>.<span style=color:#a6e22e>dateRange</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>asOfDate</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>config</span>.<span style=color:#a6e22e>asOfDate</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>format</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>config</span>.<span style=color:#a6e22e>format</span> <span style=color:#f92672>||</span> <span style=color:#e6db74>&#39;pdf&#39;</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>includeCharts</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>true</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>includeComparisons</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Add executive summary for management reports
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>config</span>.<span style=color:#a6e22e>recipients</span>.<span style=color:#a6e22e>some</span>(<span style=color:#a6e22e>email</span> =&gt; <span style=color:#a6e22e>email</span>.<span style=color:#a6e22e>includes</span>(<span style=color:#e6db74>&#39;ceo&#39;</span>) <span style=color:#f92672>||</span> <span style=color:#a6e22e>email</span>.<span style=color:#a6e22e>includes</span>(<span style=color:#e6db74>&#39;management&#39;</span>))) {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>report</span>.<span style=color:#a6e22e>executiveSummary</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>generateExecutiveSummary</span>(<span style=color:#a6e22e>report</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Distribute via email
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>distributeReport</span>(<span style=color:#a6e22e>report</span>, <span style=color:#a6e22e>config</span>.<span style=color:#a6e22e>recipients</span>, <span style=color:#a6e22e>config</span>.<span style=color:#a6e22e>name</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Store in document management system
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>archiveReport</span>(<span style=color:#a6e22e>report</span>, <span style=color:#a6e22e>config</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Log the generation
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#e6db74>`✅ Generated and distributed: </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>config</span>.<span style=color:#a6e22e>name</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}</span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx:opacity-0 hx:transition hx:group-hover/code:opacity-100 hx:flex hx:gap-1 hx:absolute hx:m-[11px] hx:right-0 hx:top-0"><button class="hextra-code-copy-btn hx:group/copybtn hx:cursor-pointer hx:transition-all hx:active:opacity-50 hx:bg-primary-700/5 hx:border hx:border-black/5 hx:text-gray-600 hx:hover:text-gray-900 hx:rounded-md hx:p-1.5 hx:dark:bg-primary-300/10 hx:dark:border-white/10 hx:dark:text-gray-400 hx:dark:hover:text-gray-50" title="Copy code"><div class="copy-icon hx:group-[.copied]/copybtn:hidden hx:pointer-events-none hx:h-4 hx:w-4"></div><div class="success-icon hx:hidden hx:group-[.copied]/copybtn:block hx:pointer-events-none hx:h-4 hx:w-4"></div></button></div></div><h3>Automated Maintenance Tasks<span class="hx:absolute hx:-mt-20" id=automated-maintenance-tasks></span>
<a href=#automated-maintenance-tasks class=subheading-anchor aria-label="Permalink for this section"></a></h3><div class="hextra-code-block hx:relative hx:mt-6 hx:first:mt-0 hx:group/code"><div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#75715e>// maintenance/automated-maintenance.js
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>AutomatedMaintenanceTasks</span> {
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>constructor</span>() {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>bigledger</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>BigLedgerClient</span>({
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>apiKey</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>process</span>.<span style=color:#a6e22e>env</span>.<span style=color:#a6e22e>BIGLEDGER_API_KEY</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>companyId</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>process</span>.<span style=color:#a6e22e>env</span>.<span style=color:#a6e22e>BIGLEDGER_COMPANY_ID</span>
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>startMaintenanceTasks</span>() {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Daily cleanup tasks
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>cron</span>.<span style=color:#a6e22e>schedule</span>(<span style=color:#e6db74>&#39;0 2 * * *&#39;</span>, () =&gt; {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>runDailyMaintenance</span>();
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Weekly optimization tasks
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>cron</span>.<span style=color:#a6e22e>schedule</span>(<span style=color:#e6db74>&#39;0 3 * * 0&#39;</span>, () =&gt; {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>runWeeklyMaintenance</span>();
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Monthly archival tasks  
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>cron</span>.<span style=color:#a6e22e>schedule</span>(<span style=color:#e6db74>&#39;0 4 1 * *&#39;</span>, () =&gt; {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>runMonthlyMaintenance</span>();
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>async</span> <span style=color:#a6e22e>runDailyMaintenance</span>() {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>tasks</span> <span style=color:#f92672>=</span> [
</span></span><span style=display:flex><span>      { <span style=color:#a6e22e>name</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;Clean temporary files&#39;</span>, <span style=color:#a6e22e>fn</span><span style=color:#f92672>:</span> () =&gt; <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>cleanTemporaryFiles</span>() },
</span></span><span style=display:flex><span>      { <span style=color:#a6e22e>name</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;Update exchange rates&#39;</span>, <span style=color:#a6e22e>fn</span><span style=color:#f92672>:</span> () =&gt; <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>updateExchangeRates</span>() },
</span></span><span style=display:flex><span>      { <span style=color:#a6e22e>name</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;Process pending e-invoices&#39;</span>, <span style=color:#a6e22e>fn</span><span style=color:#f92672>:</span> () =&gt; <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>processPendingEInvoices</span>() },
</span></span><span style=display:flex><span>      { <span style=color:#a6e22e>name</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;Check system health&#39;</span>, <span style=color:#a6e22e>fn</span><span style=color:#f92672>:</span> () =&gt; <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>performHealthCheck</span>() },
</span></span><span style=display:flex><span>      { <span style=color:#a6e22e>name</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;Backup critical data&#39;</span>, <span style=color:#a6e22e>fn</span><span style=color:#f92672>:</span> () =&gt; <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>backupCriticalData</span>() }
</span></span><span style=display:flex><span>    ];
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>executeMaintenance</span>(<span style=color:#e6db74>&#39;Daily&#39;</span>, <span style=color:#a6e22e>tasks</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>async</span> <span style=color:#a6e22e>runWeeklyMaintenance</span>() {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>tasks</span> <span style=color:#f92672>=</span> [
</span></span><span style=display:flex><span>      { <span style=color:#a6e22e>name</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;Optimize database indexes&#39;</span>, <span style=color:#a6e22e>fn</span><span style=color:#f92672>:</span> () =&gt; <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>optimizeDatabase</span>() },
</span></span><span style=display:flex><span>      { <span style=color:#a6e22e>name</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;Archive old audit logs&#39;</span>, <span style=color:#a6e22e>fn</span><span style=color:#f92672>:</span> () =&gt; <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>archiveAuditLogs</span>() },
</span></span><span style=display:flex><span>      { <span style=color:#a6e22e>name</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;Update currency rates history&#39;</span>, <span style=color:#a6e22e>fn</span><span style=color:#f92672>:</span> () =&gt; <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>updateCurrencyHistory</span>() },
</span></span><span style=display:flex><span>      { <span style=color:#a6e22e>name</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;Clean up expired sessions&#39;</span>, <span style=color:#a6e22e>fn</span><span style=color:#f92672>:</span> () =&gt; <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>cleanExpiredSessions</span>() },
</span></span><span style=display:flex><span>      { <span style=color:#a6e22e>name</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;Generate performance reports&#39;</span>, <span style=color:#a6e22e>fn</span><span style=color:#f92672>:</span> () =&gt; <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>generatePerformanceReports</span>() }
</span></span><span style=display:flex><span>    ];
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>executeMaintenance</span>(<span style=color:#e6db74>&#39;Weekly&#39;</span>, <span style=color:#a6e22e>tasks</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>async</span> <span style=color:#a6e22e>runMonthlyMaintenance</span>() {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>tasks</span> <span style=color:#f92672>=</span> [
</span></span><span style=display:flex><span>      { <span style=color:#a6e22e>name</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;Archive completed transactions&#39;</span>, <span style=color:#a6e22e>fn</span><span style=color:#f92672>:</span> () =&gt; <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>archiveTransactions</span>() },
</span></span><span style=display:flex><span>      { <span style=color:#a6e22e>name</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;Update customer risk scores&#39;</span>, <span style=color:#a6e22e>fn</span><span style=color:#f92672>:</span> () =&gt; <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>updateRiskScores</span>() },
</span></span><span style=display:flex><span>      { <span style=color:#a6e22e>name</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;Cleanup old document versions&#39;</span>, <span style=color:#a6e22e>fn</span><span style=color:#f92672>:</span> () =&gt; <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>cleanupDocumentVersions</span>() },
</span></span><span style=display:flex><span>      { <span style=color:#a6e22e>name</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;Generate monthly compliance report&#39;</span>, <span style=color:#a6e22e>fn</span><span style=color:#f92672>:</span> () =&gt; <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>generateComplianceReport</span>() }
</span></span><span style=display:flex><span>    ];
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>executeMaintenance</span>(<span style=color:#e6db74>&#39;Monthly&#39;</span>, <span style=color:#a6e22e>tasks</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>async</span> <span style=color:#a6e22e>executeMaintenance</span>(<span style=color:#a6e22e>type</span>, <span style=color:#a6e22e>tasks</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>startTime</span> <span style=color:#f92672>=</span> Date.<span style=color:#a6e22e>now</span>();
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>results</span> <span style=color:#f92672>=</span> [];
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#e6db74>`🔧 Starting </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>type</span>.<span style=color:#a6e22e>toLowerCase</span>()<span style=color:#e6db74>}</span><span style=color:#e6db74> maintenance tasks...`</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>const</span> <span style=color:#a6e22e>task</span> <span style=color:#66d9ef>of</span> <span style=color:#a6e22e>tasks</span>) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>taskStart</span> <span style=color:#f92672>=</span> Date.<span style=color:#a6e22e>now</span>();
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>task</span>.<span style=color:#a6e22e>fn</span>();
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>duration</span> <span style=color:#f92672>=</span> Date.<span style=color:#a6e22e>now</span>() <span style=color:#f92672>-</span> <span style=color:#a6e22e>taskStart</span>;
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>results</span>.<span style=color:#a6e22e>push</span>({ <span style=color:#a6e22e>name</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>task</span>.<span style=color:#a6e22e>name</span>, <span style=color:#a6e22e>status</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;success&#39;</span>, <span style=color:#a6e22e>duration</span> });
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#e6db74>`✅ </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>task</span>.<span style=color:#a6e22e>name</span><span style=color:#e6db74>}</span><span style=color:#e6db74> completed in </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>duration</span><span style=color:#e6db74>}</span><span style=color:#e6db74>ms`</span>);
</span></span><span style=display:flex><span>      } <span style=color:#66d9ef>catch</span> (<span style=color:#a6e22e>error</span>) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>duration</span> <span style=color:#f92672>=</span> Date.<span style=color:#a6e22e>now</span>() <span style=color:#f92672>-</span> <span style=color:#a6e22e>taskStart</span>;
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>results</span>.<span style=color:#a6e22e>push</span>({ <span style=color:#a6e22e>name</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>task</span>.<span style=color:#a6e22e>name</span>, <span style=color:#a6e22e>status</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;failed&#39;</span>, <span style=color:#a6e22e>duration</span>, <span style=color:#a6e22e>error</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>error</span>.<span style=color:#a6e22e>message</span> });
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>error</span>(<span style=color:#e6db74>`❌ </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>task</span>.<span style=color:#a6e22e>name</span><span style=color:#e6db74>}</span><span style=color:#e6db74> failed:`</span>, <span style=color:#a6e22e>error</span>.<span style=color:#a6e22e>message</span>);
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>totalDuration</span> <span style=color:#f92672>=</span> Date.<span style=color:#a6e22e>now</span>() <span style=color:#f92672>-</span> <span style=color:#a6e22e>startTime</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>summary</span> <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>type</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>totalDuration</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>tasksCompleted</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>results</span>.<span style=color:#a6e22e>filter</span>(<span style=color:#a6e22e>r</span> =&gt; <span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>status</span> <span style=color:#f92672>===</span> <span style=color:#e6db74>&#39;success&#39;</span>).<span style=color:#a6e22e>length</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>tasksFailed</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>results</span>.<span style=color:#a6e22e>filter</span>(<span style=color:#a6e22e>r</span> =&gt; <span style=color:#a6e22e>r</span>.<span style=color:#a6e22e>status</span> <span style=color:#f92672>===</span> <span style=color:#e6db74>&#39;failed&#39;</span>).<span style=color:#a6e22e>length</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>results</span>
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Send maintenance report
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>sendMaintenanceReport</span>(<span style=color:#a6e22e>summary</span>);
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#e6db74>`🏁 </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>type</span><span style=color:#e6db74>}</span><span style=color:#e6db74> maintenance completed in </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>totalDuration</span><span style=color:#e6db74>}</span><span style=color:#e6db74>ms`</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}</span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx:opacity-0 hx:transition hx:group-hover/code:opacity-100 hx:flex hx:gap-1 hx:absolute hx:m-[11px] hx:right-0 hx:top-0"><button class="hextra-code-copy-btn hx:group/copybtn hx:cursor-pointer hx:transition-all hx:active:opacity-50 hx:bg-primary-700/5 hx:border hx:border-black/5 hx:text-gray-600 hx:hover:text-gray-900 hx:rounded-md hx:p-1.5 hx:dark:bg-primary-300/10 hx:dark:border-white/10 hx:dark:text-gray-400 hx:dark:hover:text-gray-50" title="Copy code"><div class="copy-icon hx:group-[.copied]/copybtn:hidden hx:pointer-events-none hx:h-4 hx:w-4"></div><div class="success-icon hx:hidden hx:group-[.copied]/copybtn:block hx:pointer-events-none hx:h-4 hx:w-4"></div></button></div></div><h2>Integration Automation<span class="hx:absolute hx:-mt-20" id=integration-automation></span>
<a href=#integration-automation class=subheading-anchor aria-label="Permalink for this section"></a></h2><h3>Third-Party System Synchronization<span class="hx:absolute hx:-mt-20" id=third-party-system-synchronization></span>
<a href=#third-party-system-synchronization class=subheading-anchor aria-label="Permalink for this section"></a></h3><div class="hextra-code-block hx:relative hx:mt-6 hx:first:mt-0 hx:group/code"><div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#75715e>// integrations/sync-manager.js
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>IntegrationSyncManager</span> {
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>constructor</span>() {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>bigledger</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>BigLedgerClient</span>({
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>apiKey</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>process</span>.<span style=color:#a6e22e>env</span>.<span style=color:#a6e22e>BIGLEDGER_API_KEY</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>companyId</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>process</span>.<span style=color:#a6e22e>env</span>.<span style=color:#a6e22e>BIGLEDGER_COMPANY_ID</span>
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>integrations</span> <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>shopify</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>ShopifyIntegration</span>(),
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>stripe</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>StripeIntegration</span>(),
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>quickbooks</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>QuickBooksIntegration</span>(),
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>warehouse</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>WarehouseIntegration</span>()
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>startSyncProcesses</span>() {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Real-time sync via webhooks
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>setupWebhookSync</span>();
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Scheduled batch sync
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>setupBatchSync</span>();
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Error recovery sync
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>setupErrorRecovery</span>();
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>setupWebhookSync</span>() {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Shopify order sync
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>bigledger</span>.<span style=color:#a6e22e>webhooks</span>.<span style=color:#a6e22e>on</span>(<span style=color:#e6db74>&#39;sales_order.created&#39;</span>, <span style=color:#66d9ef>async</span> (<span style=color:#a6e22e>event</span>) =&gt; {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>syncOrderToShopify</span>(<span style=color:#a6e22e>event</span>.<span style=color:#a6e22e>data</span>.<span style=color:#a6e22e>object</span>);
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Inventory sync
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>bigledger</span>.<span style=color:#a6e22e>webhooks</span>.<span style=color:#a6e22e>on</span>(<span style=color:#e6db74>&#39;inventory.adjustment&#39;</span>, <span style=color:#66d9ef>async</span> (<span style=color:#a6e22e>event</span>) =&gt; {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>syncInventoryToAllPlatforms</span>(<span style=color:#a6e22e>event</span>.<span style=color:#a6e22e>data</span>.<span style=color:#a6e22e>object</span>);
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Payment sync
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>bigledger</span>.<span style=color:#a6e22e>webhooks</span>.<span style=color:#a6e22e>on</span>(<span style=color:#e6db74>&#39;payment.received&#39;</span>, <span style=color:#66d9ef>async</span> (<span style=color:#a6e22e>event</span>) =&gt; {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>syncPaymentToAccounting</span>(<span style=color:#a6e22e>event</span>.<span style=color:#a6e22e>data</span>.<span style=color:#a6e22e>object</span>);
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>setupBatchSync</span>() {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Hourly customer sync
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>cron</span>.<span style=color:#a6e22e>schedule</span>(<span style=color:#e6db74>&#39;0 * * * *&#39;</span>, () =&gt; {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>syncCustomersFromAllPlatforms</span>();
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Daily product sync
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>cron</span>.<span style=color:#a6e22e>schedule</span>(<span style=color:#e6db74>&#39;0 6 * * *&#39;</span>, () =&gt; {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>syncProductsToAllPlatforms</span>();
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Daily financial sync
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>cron</span>.<span style=color:#a6e22e>schedule</span>(<span style=color:#e6db74>&#39;0 23 * * *&#39;</span>, () =&gt; {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>syncFinancialDataToAccounting</span>();
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>async</span> <span style=color:#a6e22e>syncOrderToShopify</span>(<span style=color:#a6e22e>order</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>shopifyOrder</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>transformOrderForShopify</span>(<span style=color:#a6e22e>order</span>);
</span></span><span style=display:flex><span>      
</span></span><span style=display:flex><span>      <span style=color:#75715e>// Create or update order in Shopify
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>result</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>integrations</span>.<span style=color:#a6e22e>shopify</span>.<span style=color:#a6e22e>orders</span>.<span style=color:#a6e22e>upsert</span>(<span style=color:#a6e22e>shopifyOrder</span>);
</span></span><span style=display:flex><span>      
</span></span><span style=display:flex><span>      <span style=color:#75715e>// Update BigLedger with Shopify order ID
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>bigledger</span>.<span style=color:#a6e22e>salesOrders</span>.<span style=color:#a6e22e>update</span>(<span style=color:#a6e22e>order</span>.<span style=color:#a6e22e>id</span>, {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>externalReferences</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>shopify</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>result</span>.<span style=color:#a6e22e>id</span>
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>      });
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#75715e>// Sync inventory levels
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>syncInventoryToShopify</span>(<span style=color:#a6e22e>order</span>.<span style=color:#a6e22e>items</span>);
</span></span><span style=display:flex><span>      
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#e6db74>`✅ Order </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>order</span>.<span style=color:#a6e22e>orderNumber</span><span style=color:#e6db74>}</span><span style=color:#e6db74> synced to Shopify`</span>);
</span></span><span style=display:flex><span>      
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>catch</span> (<span style=color:#a6e22e>error</span>) {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>error</span>(<span style=color:#e6db74>`❌ Failed to sync order </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>order</span>.<span style=color:#a6e22e>id</span><span style=color:#e6db74>}</span><span style=color:#e6db74> to Shopify:`</span>, <span style=color:#a6e22e>error</span>);
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>queueRetrySync</span>(<span style=color:#e6db74>&#39;shopify&#39;</span>, <span style=color:#e6db74>&#39;order&#39;</span>, <span style=color:#a6e22e>order</span>.<span style=color:#a6e22e>id</span>, <span style=color:#a6e22e>error</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>async</span> <span style=color:#a6e22e>syncInventoryToAllPlatforms</span>(<span style=color:#a6e22e>inventoryItem</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>syncTasks</span> <span style=color:#f92672>=</span> Object.<span style=color:#a6e22e>entries</span>(<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>integrations</span>).<span style=color:#a6e22e>map</span>(<span style=color:#66d9ef>async</span> ([<span style=color:#a6e22e>platform</span>, <span style=color:#a6e22e>integration</span>]) =&gt; {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>integration</span>.<span style=color:#a6e22e>inventory</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>integration</span>.<span style=color:#a6e22e>inventory</span>.<span style=color:#a6e22e>updateStock</span>) {
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>integration</span>.<span style=color:#a6e22e>inventory</span>.<span style=color:#a6e22e>updateStock</span>({
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>sku</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>inventoryItem</span>.<span style=color:#a6e22e>sku</span>,
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>quantity</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>inventoryItem</span>.<span style=color:#a6e22e>currentStock</span>,
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>location</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>inventoryItem</span>.<span style=color:#a6e22e>location</span>
</span></span><span style=display:flex><span>          });
</span></span><span style=display:flex><span>          
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#e6db74>`✅ Inventory synced to </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>platform</span><span style=color:#e6db74>}</span><span style=color:#e6db74>: </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>inventoryItem</span>.<span style=color:#a6e22e>sku</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>      } <span style=color:#66d9ef>catch</span> (<span style=color:#a6e22e>error</span>) {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>error</span>(<span style=color:#e6db74>`❌ Failed to sync inventory to </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>platform</span><span style=color:#e6db74>}</span><span style=color:#e6db74>:`</span>, <span style=color:#a6e22e>error</span>);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>queueRetrySync</span>(<span style=color:#a6e22e>platform</span>, <span style=color:#e6db74>&#39;inventory&#39;</span>, <span style=color:#a6e22e>inventoryItem</span>.<span style=color:#a6e22e>id</span>, <span style=color:#a6e22e>error</span>);
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>await</span> Promise.<span style=color:#a6e22e>allSettled</span>(<span style=color:#a6e22e>syncTasks</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>async</span> <span style=color:#a6e22e>setupErrorRecovery</span>() {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Process failed sync queue every 15 minutes
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>cron</span>.<span style=color:#a6e22e>schedule</span>(<span style=color:#e6db74>&#39;*/15 * * * *&#39;</span>, () =&gt; {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>processFailedSyncQueue</span>();
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>async</span> <span style=color:#a6e22e>processFailedSyncQueue</span>() {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>failedSyncs</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>getFailedSyncs</span>();
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>const</span> <span style=color:#a6e22e>sync</span> <span style=color:#66d9ef>of</span> <span style=color:#a6e22e>failedSyncs</span>) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>sync</span>.<span style=color:#a6e22e>retryCount</span> <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>5</span>) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>retrySyncOperation</span>(<span style=color:#a6e22e>sync</span>);
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>markSyncAsSuccessful</span>(<span style=color:#a6e22e>sync</span>.<span style=color:#a6e22e>id</span>);
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#e6db74>`✅ Retry successful for </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>sync</span>.<span style=color:#a6e22e>platform</span><span style=color:#e6db74>}</span><span style=color:#e6db74> </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>sync</span>.<span style=color:#a6e22e>type</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>);
</span></span><span style=display:flex><span>        } <span style=color:#66d9ef>catch</span> (<span style=color:#a6e22e>error</span>) {
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>incrementRetryCount</span>(<span style=color:#a6e22e>sync</span>.<span style=color:#a6e22e>id</span>);
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>error</span>(<span style=color:#e6db74>`❌ Retry failed for </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>sync</span>.<span style=color:#a6e22e>platform</span><span style=color:#e6db74>}</span><span style=color:#e6db74> </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>sync</span>.<span style=color:#a6e22e>type</span><span style=color:#e6db74>}</span><span style=color:#e6db74>:`</span>, <span style=color:#a6e22e>error</span>);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>      } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// Mark as permanently failed and notify administrators
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>markSyncAsFailedPermanently</span>(<span style=color:#a6e22e>sync</span>.<span style=color:#a6e22e>id</span>);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>notifyAdministrators</span>(<span style=color:#a6e22e>sync</span>);
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}</span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx:opacity-0 hx:transition hx:group-hover/code:opacity-100 hx:flex hx:gap-1 hx:absolute hx:m-[11px] hx:right-0 hx:top-0"><button class="hextra-code-copy-btn hx:group/copybtn hx:cursor-pointer hx:transition-all hx:active:opacity-50 hx:bg-primary-700/5 hx:border hx:border-black/5 hx:text-gray-600 hx:hover:text-gray-900 hx:rounded-md hx:p-1.5 hx:dark:bg-primary-300/10 hx:dark:border-white/10 hx:dark:text-gray-400 hx:dark:hover:text-gray-50" title="Copy code"><div class="copy-icon hx:group-[.copied]/copybtn:hidden hx:pointer-events-none hx:h-4 hx:w-4"></div><div class="success-icon hx:hidden hx:group-[.copied]/copybtn:block hx:pointer-events-none hx:h-4 hx:w-4"></div></button></div></div><h2>Approval Workflows<span class="hx:absolute hx:-mt-20" id=approval-workflows></span>
<a href=#approval-workflows class=subheading-anchor aria-label="Permalink for this section"></a></h2><h3>Multi-Stage Approval Process<span class="hx:absolute hx:-mt-20" id=multi-stage-approval-process></span>
<a href=#multi-stage-approval-process class=subheading-anchor aria-label="Permalink for this section"></a></h3><div class="hextra-code-block hx:relative hx:mt-6 hx:first:mt-0 hx:group/code"><div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#75715e>// workflows/approval-workflow.js
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>ApprovalWorkflow</span> {
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>constructor</span>(<span style=color:#a6e22e>workflowContext</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>context</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>workflowContext</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>bigledger</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>workflowContext</span>.<span style=color:#a6e22e>bigledger</span>;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>async</span> <span style=color:#a6e22e>execute</span>() {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> { <span style=color:#a6e22e>entityType</span>, <span style=color:#a6e22e>entityId</span>, <span style=color:#a6e22e>approvalType</span>, <span style=color:#a6e22e>requestedBy</span> } <span style=color:#f92672>=</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>input</span>;
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>      <span style=color:#75715e>// Get approval configuration
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>approvalConfig</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>getApprovalConfig</span>(<span style=color:#a6e22e>entityType</span>, <span style=color:#a6e22e>approvalType</span>);
</span></span><span style=display:flex><span>      
</span></span><span style=display:flex><span>      <span style=color:#75715e>// Create approval request
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>approvalRequest</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>createApprovalRequest</span>({
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>entityType</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>entityId</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>approvalType</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>requestedBy</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>approvers</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>approvalConfig</span>.<span style=color:#a6e22e>approvers</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>rules</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>approvalConfig</span>.<span style=color:#a6e22e>rules</span>
</span></span><span style=display:flex><span>      });
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#75715e>// Start approval process
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>processApproval</span>(<span style=color:#a6e22e>approvalRequest</span>, <span style=color:#a6e22e>approvalConfig</span>);
</span></span><span style=display:flex><span>      
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>catch</span> (<span style=color:#a6e22e>error</span>) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>handleApprovalError</span>(<span style=color:#a6e22e>error</span>);
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>throw</span> <span style=color:#a6e22e>error</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>async</span> <span style=color:#a6e22e>getApprovalConfig</span>(<span style=color:#a6e22e>entityType</span>, <span style=color:#a6e22e>approvalType</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>configs</span> <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#39;purchase_order&#39;</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#39;standard&#39;</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>approvers</span><span style=color:#f92672>:</span> [
</span></span><span style=display:flex><span>            { <span style=color:#a6e22e>role</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;department_manager&#39;</span>, <span style=color:#a6e22e>required</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>true</span>, <span style=color:#a6e22e>order</span><span style=color:#f92672>:</span> <span style=color:#ae81ff>1</span> },
</span></span><span style=display:flex><span>            { <span style=color:#a6e22e>role</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;finance_manager&#39;</span>, <span style=color:#a6e22e>required</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>true</span>, <span style=color:#a6e22e>order</span><span style=color:#f92672>:</span> <span style=color:#ae81ff>2</span> }
</span></span><span style=display:flex><span>          ],
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>rules</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>maxAmount</span><span style=color:#f92672>:</span> <span style=color:#ae81ff>10000</span>,
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>timeoutHours</span><span style=color:#f92672>:</span> <span style=color:#ae81ff>48</span>
</span></span><span style=display:flex><span>          }
</span></span><span style=display:flex><span>        },
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#39;high_value&#39;</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>approvers</span><span style=color:#f92672>:</span> [
</span></span><span style=display:flex><span>            { <span style=color:#a6e22e>role</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;department_manager&#39;</span>, <span style=color:#a6e22e>required</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>true</span>, <span style=color:#a6e22e>order</span><span style=color:#f92672>:</span> <span style=color:#ae81ff>1</span> },
</span></span><span style=display:flex><span>            { <span style=color:#a6e22e>role</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;finance_manager&#39;</span>, <span style=color:#a6e22e>required</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>true</span>, <span style=color:#a6e22e>order</span><span style=color:#f92672>:</span> <span style=color:#ae81ff>2</span> },
</span></span><span style=display:flex><span>            { <span style=color:#a6e22e>role</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;cfo&#39;</span>, <span style=color:#a6e22e>required</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>true</span>, <span style=color:#a6e22e>order</span><span style=color:#f92672>:</span> <span style=color:#ae81ff>3</span> },
</span></span><span style=display:flex><span>            { <span style=color:#a6e22e>role</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;ceo&#39;</span>, <span style=color:#a6e22e>required</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>false</span>, <span style=color:#a6e22e>order</span><span style=color:#f92672>:</span> <span style=color:#ae81ff>4</span> }
</span></span><span style=display:flex><span>          ],
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>rules</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>minAmount</span><span style=color:#f92672>:</span> <span style=color:#ae81ff>10000</span>,
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>timeoutHours</span><span style=color:#f92672>:</span> <span style=color:#ae81ff>72</span>
</span></span><span style=display:flex><span>          }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>      },
</span></span><span style=display:flex><span>      <span style=color:#e6db74>&#39;expense_report&#39;</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#39;standard&#39;</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>approvers</span><span style=color:#f92672>:</span> [
</span></span><span style=display:flex><span>            { <span style=color:#a6e22e>role</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;line_manager&#39;</span>, <span style=color:#a6e22e>required</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>true</span>, <span style=color:#a6e22e>order</span><span style=color:#f92672>:</span> <span style=color:#ae81ff>1</span> }
</span></span><span style=display:flex><span>          ],
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>rules</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>maxAmount</span><span style=color:#f92672>:</span> <span style=color:#ae81ff>1000</span>,
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>timeoutHours</span><span style=color:#f92672>:</span> <span style=color:#ae81ff>24</span>
</span></span><span style=display:flex><span>          }
</span></span><span style=display:flex><span>        },
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#39;high_value&#39;</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>approvers</span><span style=color:#f92672>:</span> [
</span></span><span style=display:flex><span>            { <span style=color:#a6e22e>role</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;line_manager&#39;</span>, <span style=color:#a6e22e>required</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>true</span>, <span style=color:#a6e22e>order</span><span style=color:#f92672>:</span> <span style=color:#ae81ff>1</span> },
</span></span><span style=display:flex><span>            { <span style=color:#a6e22e>role</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;finance_manager&#39;</span>, <span style=color:#a6e22e>required</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>true</span>, <span style=color:#a6e22e>order</span><span style=color:#f92672>:</span> <span style=color:#ae81ff>2</span> }
</span></span><span style=display:flex><span>          ],
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>rules</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>minAmount</span><span style=color:#f92672>:</span> <span style=color:#ae81ff>1000</span>,
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>timeoutHours</span><span style=color:#f92672>:</span> <span style=color:#ae81ff>48</span>
</span></span><span style=display:flex><span>          }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>configs</span>[<span style=color:#a6e22e>entityType</span>]<span style=color:#f92672>?</span>.[<span style=color:#a6e22e>approvalType</span>] <span style=color:#f92672>||</span> <span style=color:#a6e22e>configs</span>[<span style=color:#a6e22e>entityType</span>]<span style=color:#f92672>?</span>.[<span style=color:#e6db74>&#39;standard&#39;</span>];
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>async</span> <span style=color:#a6e22e>processApproval</span>(<span style=color:#a6e22e>approvalRequest</span>, <span style=color:#a6e22e>config</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>approvers</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>config</span>.<span style=color:#a6e22e>approvers</span>.<span style=color:#a6e22e>sort</span>((<span style=color:#a6e22e>a</span>, <span style=color:#a6e22e>b</span>) =&gt; <span style=color:#a6e22e>a</span>.<span style=color:#a6e22e>order</span> <span style=color:#f92672>-</span> <span style=color:#a6e22e>b</span>.<span style=color:#a6e22e>order</span>);
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>const</span> <span style=color:#a6e22e>approver</span> <span style=color:#66d9ef>of</span> <span style=color:#a6e22e>approvers</span>) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>approver</span>.<span style=color:#a6e22e>required</span>) {
</span></span><span style=display:flex><span>        <span style=color:#75715e>// Send approval notification
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>sendApprovalNotification</span>(<span style=color:#a6e22e>approvalRequest</span>, <span style=color:#a6e22e>approver</span>);
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        <span style=color:#75715e>// Wait for approval with timeout
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>approval</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>waitForApproval</span>(
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>approvalRequest</span>.<span style=color:#a6e22e>id</span>, 
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>approver</span>.<span style=color:#a6e22e>role</span>, 
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>config</span>.<span style=color:#a6e22e>rules</span>.<span style=color:#a6e22e>timeoutHours</span>
</span></span><span style=display:flex><span>        );
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>approval</span>.<span style=color:#a6e22e>status</span> <span style=color:#f92672>===</span> <span style=color:#e6db74>&#39;approved&#39;</span>) {
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>recordApproval</span>(<span style=color:#a6e22e>approvalRequest</span>.<span style=color:#a6e22e>id</span>, <span style=color:#a6e22e>approver</span>.<span style=color:#a6e22e>role</span>, <span style=color:#a6e22e>approval</span>);
</span></span><span style=display:flex><span>        } <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>approval</span>.<span style=color:#a6e22e>status</span> <span style=color:#f92672>===</span> <span style=color:#e6db74>&#39;rejected&#39;</span>) {
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>recordRejection</span>(<span style=color:#a6e22e>approvalRequest</span>.<span style=color:#a6e22e>id</span>, <span style=color:#a6e22e>approver</span>.<span style=color:#a6e22e>role</span>, <span style=color:#a6e22e>approval</span>);
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>return</span> { <span style=color:#a6e22e>status</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;rejected&#39;</span>, <span style=color:#a6e22e>rejectedBy</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>approver</span>.<span style=color:#a6e22e>role</span>, <span style=color:#a6e22e>reason</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>approval</span>.<span style=color:#a6e22e>reason</span> };
</span></span><span style=display:flex><span>        } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>          <span style=color:#75715e>// Timeout occurred
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>          <span style=color:#66d9ef>return</span> { <span style=color:#a6e22e>status</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;timeout&#39;</span>, <span style=color:#a6e22e>approver</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>approver</span>.<span style=color:#a6e22e>role</span> };
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// All required approvals received
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>finalizeApproval</span>(<span style=color:#a6e22e>approvalRequest</span>.<span style=color:#a6e22e>id</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> { <span style=color:#a6e22e>status</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;approved&#39;</span> };
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>async</span> <span style=color:#a6e22e>sendApprovalNotification</span>(<span style=color:#a6e22e>approvalRequest</span>, <span style=color:#a6e22e>approver</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>users</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>getUsersByRole</span>(<span style=color:#a6e22e>approver</span>.<span style=color:#a6e22e>role</span>);
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>const</span> <span style=color:#a6e22e>user</span> <span style=color:#66d9ef>of</span> <span style=color:#a6e22e>users</span>) {
</span></span><span style=display:flex><span>      <span style=color:#75715e>// Send email notification
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>sendEmail</span>({
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>to</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>user</span>.<span style=color:#a6e22e>email</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>subject</span><span style=color:#f92672>:</span> <span style=color:#e6db74>`Approval Required: </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>approvalRequest</span>.<span style=color:#a6e22e>entityType</span><span style=color:#e6db74>}</span><span style=color:#e6db74> </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>approvalRequest</span>.<span style=color:#a6e22e>entityId</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>template</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;approval-request&#39;</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>data</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>approvalRequest</span>,
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>approver</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>user</span>,
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>approvalLink</span><span style=color:#f92672>:</span> <span style=color:#e6db74>`</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>process</span>.<span style=color:#a6e22e>env</span>.<span style=color:#a6e22e>APPROVAL_PORTAL_URL</span><span style=color:#e6db74>}</span><span style=color:#e6db74>/approve/</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>approvalRequest</span>.<span style=color:#a6e22e>id</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>,
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>timeoutHours</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>approver</span>.<span style=color:#a6e22e>timeoutHours</span>
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>      });
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#75715e>// Send in-app notification
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>bigledger</span>.<span style=color:#a6e22e>notifications</span>.<span style=color:#a6e22e>create</span>({
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>userId</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>user</span>.<span style=color:#a6e22e>id</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>type</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;approval_request&#39;</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>title</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;Approval Required&#39;</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>message</span><span style=color:#f92672>:</span> <span style=color:#e6db74>`</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>approvalRequest</span>.<span style=color:#a6e22e>entityType</span><span style=color:#e6db74>}</span><span style=color:#e6db74> requires your approval`</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>data</span><span style=color:#f92672>:</span> { <span style=color:#a6e22e>approvalRequestId</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>approvalRequest</span>.<span style=color:#a6e22e>id</span> }
</span></span><span style=display:flex><span>      });
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>async</span> <span style=color:#a6e22e>waitForApproval</span>(<span style=color:#a6e22e>approvalRequestId</span>, <span style=color:#a6e22e>approverRole</span>, <span style=color:#a6e22e>timeoutHours</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> Promise((<span style=color:#a6e22e>resolve</span>) =&gt; {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>timeout</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>setTimeout</span>(() =&gt; {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>resolve</span>({ <span style=color:#a6e22e>status</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;timeout&#39;</span> });
</span></span><span style=display:flex><span>      }, <span style=color:#a6e22e>timeoutHours</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>60</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>60</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>1000</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#75715e>// Listen for approval webhook
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>context</span>.<span style=color:#a6e22e>onWebhook</span>(<span style=color:#e6db74>`approval.</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>approvalRequestId</span><span style=color:#e6db74>}</span><span style=color:#e6db74>.</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>approverRole</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>, (<span style=color:#a6e22e>event</span>) =&gt; {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>clearTimeout</span>(<span style=color:#a6e22e>timeout</span>);
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>resolve</span>(<span style=color:#a6e22e>event</span>.<span style=color:#a6e22e>data</span>);
</span></span><span style=display:flex><span>      });
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#75715e>// Also check periodically in case webhook fails
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>checkInterval</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>setInterval</span>(<span style=color:#66d9ef>async</span> () =&gt; {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>approval</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>checkApprovalStatus</span>(<span style=color:#a6e22e>approvalRequestId</span>, <span style=color:#a6e22e>approverRole</span>);
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>approval</span>) {
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>clearTimeout</span>(<span style=color:#a6e22e>timeout</span>);
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>clearInterval</span>(<span style=color:#a6e22e>checkInterval</span>);
</span></span><span style=display:flex><span>          <span style=color:#a6e22e>resolve</span>(<span style=color:#a6e22e>approval</span>);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>      }, <span style=color:#ae81ff>5</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>60</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>1000</span>); <span style=color:#75715e>// Check every 5 minutes
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    });
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}</span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx:opacity-0 hx:transition hx:group-hover/code:opacity-100 hx:flex hx:gap-1 hx:absolute hx:m-[11px] hx:right-0 hx:top-0"><button class="hextra-code-copy-btn hx:group/copybtn hx:cursor-pointer hx:transition-all hx:active:opacity-50 hx:bg-primary-700/5 hx:border hx:border-black/5 hx:text-gray-600 hx:hover:text-gray-900 hx:rounded-md hx:p-1.5 hx:dark:bg-primary-300/10 hx:dark:border-white/10 hx:dark:text-gray-400 hx:dark:hover:text-gray-50" title="Copy code"><div class="copy-icon hx:group-[.copied]/copybtn:hidden hx:pointer-events-none hx:h-4 hx:w-4"></div><div class="success-icon hx:hidden hx:group-[.copied]/copybtn:block hx:pointer-events-none hx:h-4 hx:w-4"></div></button></div></div><h2>Monitoring and Analytics<span class="hx:absolute hx:-mt-20" id=monitoring-and-analytics></span>
<a href=#monitoring-and-analytics class=subheading-anchor aria-label="Permalink for this section"></a></h2><h3>Workflow Performance Monitoring<span class="hx:absolute hx:-mt-20" id=workflow-performance-monitoring></span>
<a href=#workflow-performance-monitoring class=subheading-anchor aria-label="Permalink for this section"></a></h3><div class="hextra-code-block hx:relative hx:mt-6 hx:first:mt-0 hx:group/code"><div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#75715e>// monitoring/workflow-monitor.js
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>WorkflowMonitor</span> {
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>constructor</span>() {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>metrics</span> <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>workflowsStarted</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>Counter</span>(<span style=color:#e6db74>&#39;workflows_started_total&#39;</span>, [<span style=color:#e6db74>&#39;workflow_type&#39;</span>, <span style=color:#e6db74>&#39;status&#39;</span>]),
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>workflowDuration</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>Histogram</span>(<span style=color:#e6db74>&#39;workflow_duration_seconds&#39;</span>, [<span style=color:#e6db74>&#39;workflow_type&#39;</span>]),
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>workflowErrors</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>Counter</span>(<span style=color:#e6db74>&#39;workflow_errors_total&#39;</span>, [<span style=color:#e6db74>&#39;workflow_type&#39;</span>, <span style=color:#e6db74>&#39;error_type&#39;</span>]),
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>activeWorkflows</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>Gauge</span>(<span style=color:#e6db74>&#39;active_workflows&#39;</span>, [<span style=color:#e6db74>&#39;workflow_type&#39;</span>])
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>startMonitoring</span>() {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Monitor workflow health
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>setInterval</span>(() =&gt; {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>checkWorkflowHealth</span>();
</span></span><span style=display:flex><span>    }, <span style=color:#ae81ff>60000</span>); <span style=color:#75715e>// Every minute
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Generate workflow analytics
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#a6e22e>cron</span>.<span style=color:#a6e22e>schedule</span>(<span style=color:#e6db74>&#39;0 * * * *&#39;</span>, () =&gt; {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>generateWorkflowAnalytics</span>();
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Alert on workflow failures
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>setupFailureAlerts</span>();
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>async</span> <span style=color:#a6e22e>trackWorkflowStart</span>(<span style=color:#a6e22e>workflowType</span>, <span style=color:#a6e22e>workflowId</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>metrics</span>.<span style=color:#a6e22e>workflowsStarted</span>.<span style=color:#a6e22e>inc</span>({ <span style=color:#a6e22e>workflow_type</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>workflowType</span>, <span style=color:#a6e22e>status</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;started&#39;</span> });
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>metrics</span>.<span style=color:#a6e22e>activeWorkflows</span>.<span style=color:#a6e22e>inc</span>({ <span style=color:#a6e22e>workflow_type</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>workflowType</span> });
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>recordWorkflowEvent</span>({
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>workflowId</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>workflowType</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>event</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;started&#39;</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>timestamp</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>new</span> Date(),
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>metadata</span><span style=color:#f92672>:</span> {}
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>async</span> <span style=color:#a6e22e>trackWorkflowCompletion</span>(<span style=color:#a6e22e>workflowType</span>, <span style=color:#a6e22e>workflowId</span>, <span style=color:#a6e22e>duration</span>, <span style=color:#a6e22e>status</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>metrics</span>.<span style=color:#a6e22e>workflowsStarted</span>.<span style=color:#a6e22e>inc</span>({ <span style=color:#a6e22e>workflow_type</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>workflowType</span>, <span style=color:#a6e22e>status</span> });
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>metrics</span>.<span style=color:#a6e22e>workflowDuration</span>.<span style=color:#a6e22e>observe</span>({ <span style=color:#a6e22e>workflow_type</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>workflowType</span> }, <span style=color:#a6e22e>duration</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>metrics</span>.<span style=color:#a6e22e>activeWorkflows</span>.<span style=color:#a6e22e>dec</span>({ <span style=color:#a6e22e>workflow_type</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>workflowType</span> });
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>recordWorkflowEvent</span>({
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>workflowId</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>workflowType</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>event</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;completed&#39;</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>status</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>duration</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>timestamp</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>new</span> Date()
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>async</span> <span style=color:#a6e22e>trackWorkflowError</span>(<span style=color:#a6e22e>workflowType</span>, <span style=color:#a6e22e>workflowId</span>, <span style=color:#a6e22e>error</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>metrics</span>.<span style=color:#a6e22e>workflowErrors</span>.<span style=color:#a6e22e>inc</span>({ 
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>workflow_type</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>workflowType</span>, 
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>error_type</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>error</span>.<span style=color:#a6e22e>constructor</span>.<span style=color:#a6e22e>name</span> 
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>recordWorkflowEvent</span>({
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>workflowId</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>workflowType</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>event</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;error&#39;</span>,
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>error</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>name</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>error</span>.<span style=color:#a6e22e>name</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>message</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>error</span>.<span style=color:#a6e22e>message</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>stack</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>error</span>.<span style=color:#a6e22e>stack</span>
</span></span><span style=display:flex><span>      },
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>timestamp</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>new</span> Date()
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Send alert for critical errors
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> (<span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>isCriticalError</span>(<span style=color:#a6e22e>error</span>)) {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>sendCriticalErrorAlert</span>(<span style=color:#a6e22e>workflowType</span>, <span style=color:#a6e22e>workflowId</span>, <span style=color:#a6e22e>error</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>async</span> <span style=color:#a6e22e>generateWorkflowAnalytics</span>() {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>analytics</span> <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>hourly</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>getHourlyWorkflowStats</span>(),
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>daily</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>getDailyWorkflowStats</span>(),
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>weekly</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>getWeeklyWorkflowStats</span>(),
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>performance</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>getPerformanceMetrics</span>(),
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>errors</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>getErrorAnalytics</span>()
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Store analytics
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>storeAnalytics</span>(<span style=color:#a6e22e>analytics</span>);
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Generate insights
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>insights</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>generateInsights</span>(<span style=color:#a6e22e>analytics</span>);
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Send analytics report
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>await</span> <span style=color:#66d9ef>this</span>.<span style=color:#a6e22e>sendAnalyticsReport</span>(<span style=color:#a6e22e>analytics</span>, <span style=color:#a6e22e>insights</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>async</span> <span style=color:#a6e22e>generateInsights</span>(<span style=color:#a6e22e>analytics</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>insights</span> <span style=color:#f92672>=</span> [];
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Performance insights
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>analytics</span>.<span style=color:#a6e22e>performance</span>.<span style=color:#a6e22e>averageDuration</span> <span style=color:#f92672>&gt;</span> <span style=color:#a6e22e>analytics</span>.<span style=color:#a6e22e>performance</span>.<span style=color:#a6e22e>baseline</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>1.5</span>) {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>insights</span>.<span style=color:#a6e22e>push</span>({
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>type</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;performance_degradation&#39;</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>severity</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;warning&#39;</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>message</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;Workflow performance has degraded by 50% compared to baseline&#39;</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>recommendation</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;Investigate resource constraints and optimize bottlenecks&#39;</span>
</span></span><span style=display:flex><span>      });
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Error rate insights
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>analytics</span>.<span style=color:#a6e22e>errors</span>.<span style=color:#a6e22e>errorRate</span> <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>5</span>) {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>insights</span>.<span style=color:#a6e22e>push</span>({
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>type</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;high_error_rate&#39;</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>severity</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;critical&#39;</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>message</span><span style=color:#f92672>:</span> <span style=color:#e6db74>`Error rate is </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>analytics</span>.<span style=color:#a6e22e>errors</span>.<span style=color:#a6e22e>errorRate</span><span style=color:#e6db74>}</span><span style=color:#e6db74>%, above 5% threshold`</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>recommendation</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;Investigate common error patterns and implement fixes&#39;</span>
</span></span><span style=display:flex><span>      });
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// Volume insights
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>volumeChange</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>analytics</span>.<span style=color:#a6e22e>daily</span>.<span style=color:#a6e22e>today</span>.<span style=color:#a6e22e>volume</span> <span style=color:#f92672>/</span> <span style=color:#a6e22e>analytics</span>.<span style=color:#a6e22e>daily</span>.<span style=color:#a6e22e>yesterday</span>.<span style=color:#a6e22e>volume</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>volumeChange</span> <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>2</span>) {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>insights</span>.<span style=color:#a6e22e>push</span>({
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>type</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;volume_spike&#39;</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>severity</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;info&#39;</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>message</span><span style=color:#f92672>:</span> <span style=color:#e6db74>`Workflow volume increased </span><span style=color:#e6db74>${</span>Math.<span style=color:#a6e22e>round</span>(<span style=color:#a6e22e>volumeChange</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>100</span>)<span style=color:#e6db74>}</span><span style=color:#e6db74>% from yesterday`</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>recommendation</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;Monitor system resources and scaling requirements&#39;</span>
</span></span><span style=display:flex><span>      });
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>insights</span>;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}</span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx:opacity-0 hx:transition hx:group-hover/code:opacity-100 hx:flex hx:gap-1 hx:absolute hx:m-[11px] hx:right-0 hx:top-0"><button class="hextra-code-copy-btn hx:group/copybtn hx:cursor-pointer hx:transition-all hx:active:opacity-50 hx:bg-primary-700/5 hx:border hx:border-black/5 hx:text-gray-600 hx:hover:text-gray-900 hx:rounded-md hx:p-1.5 hx:dark:bg-primary-300/10 hx:dark:border-white/10 hx:dark:text-gray-400 hx:dark:hover:text-gray-50" title="Copy code"><div class="copy-icon hx:group-[.copied]/copybtn:hidden hx:pointer-events-none hx:h-4 hx:w-4"></div><div class="success-icon hx:hidden hx:group-[.copied]/copybtn:block hx:pointer-events-none hx:h-4 hx:w-4"></div></button></div></div><p>This comprehensive automation framework enables sophisticated business process automation, from simple webhook-triggered actions to complex multi-stage approval workflows. The monitoring and analytics capabilities ensure your automations run reliably and efficiently at scale.</p></div></div></article></main><footer class=corporate-footer><div class=container><div class=footer-grid><div class=footer-column><img src=https://www.bigledger.com/images/bigledger-logo-cropped.png alt="BigLedger - Complete Business Management Platform" height=32 style=margin-bottom:16px><p>Complete Business Management Platform - ERP, POS, E-Commerce & More</p></div><div class=footer-column><h4>Product</h4><ul><li><a href=https://www.bigledger.com/solutions>Solutions</a></li><li><a href=https://www.bigledger.com/pricing>Pricing</a></li><li><a href=https://www.bigledger.com/developers>Developers</a></li></ul></div><div class=footer-column><h4>Company</h4><ul><li><a href=https://www.bigledger.com/about>About</a></li><li><a href=https://www.bigledger.com/contact>Contact</a></li></ul></div><div class=footer-column><h4>Connect</h4><ul><li><a href=https://github.com/bigledger target=_blank>Github</a></li><li><a href=https://twitter.com/bigledger target=_blank>Twitter</a></li></ul></div></div><div class=footer-bottom><p>&copy; 2025 BigLedger. All rights reserved.</p></div></div></footer></body></html>